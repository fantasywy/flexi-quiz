<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>å…¨èƒ½åˆ·é¢˜ç³»ç»Ÿ - æç®€å¢å¼ºç‰ˆ</title>
    <style>
      :root {
        --primary: #4a90e2;
        --primary-light: #eef6ff;
        --success: #2ecc71;
        --error: #e74c3c;
        --warning: #f39c12;
        --text: #2c3e50;
        --bg: #f8fafc;
        --card-bg: #ffffff;
      }
      body {
        font-family: "Segoe UI", system-ui, -apple-system, sans-serif;
        background: var(--bg);
        padding: 20px;
        color: var(--text);
        margin: 0;
        line-height: 1.5;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
        background: var(--card-bg);
        padding: 30px;
        border-radius: 20px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.05);
      }
      .bank-selector-card {
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        overflow: hidden;
        margin-bottom: 25px;
        background: #fff;
      }
      .menu-section {
        border-bottom: 1px solid #f1f5f9;
      }
      .menu-header {
        padding: 16px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        font-weight: 600;
      }
      .menu-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
        background: #fafafa;
      }
      .menu-content.open {
        max-height: 1000px;
      }
      .menu-item {
        padding: 12px 45px;
        cursor: pointer;
        font-size: 0.95rem;
        color: #64748b;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .menu-item:before {
        content: "â€¢";
        color: var(--primary);
        font-weight: bold;
      }
      .config-panel {
        background: #f1f5f9;
        padding: 15px 20px;
        border-radius: 12px;
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        align-items: center;
        margin-bottom: 20px;
      }
      .config-label {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.9rem;
        cursor: pointer;
      }
      .header {
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .progress-tag {
        background: var(--primary-light);
        color: var(--primary);
        padding: 4px 12px;
        border-radius: 20px;
        font-weight: bold;
        font-size: 0.85rem;
      }
      .q-title {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 15px;
      }
      .q-img {
        max-width: 100%;
        height: auto;
        border-radius: 8px;
        margin-bottom: 20px;
        display: block;
        margin-left: auto;
        margin-right: auto;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      }
      .type-tag {
        display: inline-block;
        font-size: 0.75rem;
        padding: 2px 8px;
        background: #e2e8f0;
        border-radius: 6px;
        margin-right: 10px;
      }
      .options {
        display: grid;
        gap: 12px;
      }
      .option {
        padding: 15px 20px;
        border: 2px solid #f1f5f9;
        border-radius: 12px;
        cursor: pointer;
        background: #fff;
      }
      .option.selected {
        border-color: var(--primary);
        background: var(--primary-light);
      }
      .blank-group {
        margin-bottom: 12px;
      }
      .blank-label {
        font-size: 0.85rem;
        color: #64748b;
        margin-bottom: 4px;
        display: block;
      }
      #sheet-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        display: none;
      }
      .sheet-content {
        position: absolute;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 100%;
        max-width: 800px;
        background: #fff;
        border-radius: 20px 20px 0 0;
        padding: 25px;
        max-height: 70vh;
        overflow-y: auto;
      }
      .sheet-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(45px, 1fr));
        gap: 10px;
        margin-top: 20px;
      }
      .sheet-num {
        height: 45px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
        cursor: pointer;
        font-size: 0.9rem;
      }
      .sheet-num.done {
        background: var(--primary-light);
        color: var(--primary);
        border-color: var(--primary);
      }
      .sheet-num.current {
        border: 2px solid var(--warning);
        font-weight: bold;
      }
      .controls {
        margin-top: 30px;
        display: flex;
        gap: 12px;
      }
      button {
        padding: 12px 24px;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
      }
      .btn-main {
        background: var(--primary);
        color: white;
        flex: 2;
      }
      .btn-gray {
        background: #94a3b8;
        color: white;
        flex: 1;
      }
      .btn-warning {
        background: var(--warning);
        color: white;
      }
      .btn-outline {
        background: #fff;
        border: 1px solid #e2e8f0;
        flex: 0.5;
        font-size: 1.2rem;
      }
      .review-card {
        padding: 20px 0;
        border-bottom: 1px solid #f1f5f9;
      }
      .review-opt {
        padding: 12px 15px;
        border-radius: 10px;
        margin-top: 8px;
        border: 1px solid #f1f5f9;
        font-size: 0.95rem;
      }
      .review-opt.correct {
        background: #f0fff4;
        border-color: #c6f6d5;
        color: #276749;
      }
      .review-opt.wrong {
        background: #fff5f5;
        border-color: #fed7d7;
        color: #9b2c2c;
      }
      .review-badge {
        margin-top: 15px;
        padding: 15px;
        background: #f8fafc;
        border-radius: 12px;
        font-size: 0.9rem;
        border-left: 4px solid #cbd5e1;
      }
      .status-dot {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-right: 8px;
      }
      @media (max-width: 600px) {
        body {
          padding: 0;
          background: #fff;
        }
        .container {
          padding: 20px;
          border-radius: 0;
          box-shadow: none;
          min-height: 100vh;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div id="bank-ui">
        <h2 style="margin-top: 0">ğŸ“š ç»ƒä¹ ä¸­å¿ƒ</h2>
        <div class="config-panel">
          <label class="config-label"
            ><input type="checkbox" id="random-q" /> éšæœºé¢˜ç›®</label
          >
          <label class="config-label"
            ><input type="checkbox" id="random-opt" /> éšæœºé€‰é¡¹</label
          >
          <span style="color: #94a3b8">|</span>
          <span
            style="cursor: pointer; color: var(--primary); font-size: 0.9rem"
            onclick="document.getElementById('file-input').click()"
            >â• ä¸Šä¼ JSON</span
          >
          <input
            type="file"
            id="file-input"
            style="display: none"
            onchange="handleFileUpload(event)"
          />
        </div>
        <div class="bank-selector-card" id="menu-container">
          <div class="loading">æ­£åœ¨è·å–é¢˜åº“æ¸…å•...</div>
        </div>
      </div>

      <div id="quiz-mode" style="display: none">
        <div class="header">
          <span class="progress-tag" id="progress"></span>
          <button
            class="btn-warning"
            style="padding: 6px 12px"
            onclick="confirmEarlySubmit()"
          >
            æå‰äº¤å·
          </button>
        </div>
        <div id="q-container"></div>
        <div class="controls">
          <button class="btn-gray" onclick="move(-1)">ä¸Šä¸€é¢˜</button>
          <button class="btn-outline" onclick="toggleSheet(true)">ğŸ“‹</button>
          <button class="btn-main" id="next-btn" onclick="move(1)">
            ä¸‹ä¸€é¢˜
          </button>
        </div>
      </div>

      <div id="sheet-overlay" onclick="toggleSheet(false)">
        <div class="sheet-content" onclick="event.stopPropagation()">
          <h3 style="margin-top: 0">å…¨ä½“é¢˜ç›®é¢„è§ˆ</h3>
          <div id="sheet-grid" class="sheet-grid"></div>
        </div>
      </div>

      <div
        id="result-panel"
        style="display: none; text-align: center; padding: 40px 0"
      >
        <div style="font-size: 4rem">ğŸ¯</div>
        <h2
          id="accuracy-rate"
          style="font-size: 3rem; margin: 10px 0; color: var(--primary)"
        >
          0%
        </h2>
        <p id="score-summary" style="color: #64748b; margin-bottom: 30px"></p>
        <div class="controls">
          <button class="btn-main" onclick="enterReview()">æŸ¥çœ‹è§£æ</button>
          <button class="btn-gray" onclick="location.reload()">é€€å‡ºç»ƒä¹ </button>
        </div>
      </div>

      <div id="review-area" style="display: none">
        <h3
          style="
            margin-top: 0;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--bg);
          "
        >
          ç­”é¢˜è§£æè¯¦æƒ…
        </h3>
        <div id="review-list"></div>
        <div style="padding: 30px 0 50px">
          <button
            class="btn-gray"
            style="width: 100%"
            onclick="location.reload()"
          >
            è¿”å›é¦–é¡µ
          </button>
        </div>
      </div>
    </div>

    <script>
      let quizData = [];
      let userAnswers = [];
      let currentIndex = 0;

      window.onload = async function () {
        const container = document.getElementById("menu-container");
        try {
          const res = await fetch("data/list.json");
          const files = await res.json();
          container.innerHTML = "";
          for (const file of files) {
            const fileName = file.split(".")[0];
            const section = document.createElement("div");
            section.className = "menu-section";
            section.innerHTML = `<div class="menu-header" onclick="toggleMenu(this)"><span>ğŸ“‚ ${fileName}</span><i>â–¼</i></div><div class="menu-content"></div>`;
            container.appendChild(section);
            loadAndSplit(
              `data/${file}`,
              section.querySelector(".menu-content"),
              fileName
            );
          }
        } catch (e) {
          container.innerHTML = `<div style="padding:20px">æœªå‘ç°é¢˜åº“æ–‡ä»¶æˆ–åŠ è½½å¤±è´¥ã€‚</div>`;
        }
      };

      function toggleMenu(header) {
        header.classList.toggle("active");
        header.nextElementSibling.classList.toggle("open");
      }

      async function loadAndSplit(url, contentDiv, fileName) {
        try {
          const res = await fetch(url);
          const data = await res.json();
          for (let i = 0; i < data.length; i += 50) {
            const chunk = data.slice(i, i + 50);
            const div = document.createElement("div");
            div.className = "menu-item";
            div.innerText =
              data.length <= 50
                ? `${fileName} (å…¨é‡)`
                : `ç¬¬ ${i + 1}-${Math.min(i + 50, data.length)} é¢˜`;
            div.onclick = () => startQuiz(chunk);
            contentDiv.appendChild(div);
          }
        } catch (e) {}
      }

      function startQuiz(data) {
        quizData = JSON.parse(JSON.stringify(data));
        if (document.getElementById("random-q").checked)
          quizData.sort(() => Math.random() - 0.5);

        // å¢å¼ºåˆå§‹åŒ–ï¼šå¦‚æœæ˜¯å¡«ç©ºé¢˜ä¸”ansæ˜¯æ•°ç»„ï¼Œåˆå§‹åŒ–å¯¹åº”é•¿åº¦çš„ç©ºæ•°ç»„
        userAnswers = quizData.map((q) => {
          if (q.type === "multiple") return [];
          if (q.type === "blank" && Array.isArray(q.ans))
            return new Array(q.ans.length).fill("");
          return "";
        });

        currentIndex = 0;
        document.getElementById("bank-ui").style.display = "none";
        document.getElementById("quiz-mode").style.display = "block";
        renderQ();
      }

      function renderQ() {
        const item = quizData[currentIndex];
        document.getElementById("progress").innerText = `${
          currentIndex + 1
        } / ${quizData.length}`;

        let html = `<div class="q-title"><span class="type-tag">${
          item.type === "multiple"
            ? "å¤šé€‰"
            : item.type === "blank"
            ? "å¡«ç©º"
            : "å•é€‰"
        }</span>${item.q}</div>`;

        if (item.img) {
          html += `<img src="${item.img}" class="q-img" alt="é¢˜ç›®å›¾ç‰‡">`;
        }

        if (item.type === "blank") {
          if (Array.isArray(item.ans)) {
            // ç”Ÿæˆå¯¹åº”çš„å¤šä¸ªç©º
            item.ans.forEach((_, i) => {
              html += `<div class="blank-group">
                        <label class="blank-label">ç¬¬ ${i + 1} ç©º</label>
                        <input type="text" style="width:100%; padding:12px; border:2px solid #e2e8f0; border-radius:10px; box-sizing:border-box" 
                        value="${
                          userAnswers[currentIndex][i] || ""
                        }" oninput="userAnswers[currentIndex][${i}]=this.value">
                       </div>`;
            });
          } else {
            html += `<input type="text" style="width:100%; padding:15px; border:2px solid #e2e8f0; border-radius:12px; box-sizing:border-box" 
                     value="${userAnswers[currentIndex]}" oninput="userAnswers[currentIndex]=this.value">`;
          }
        } else {
          html += `<div class="options">`;
          item.options.forEach((opt, i) => {
            const isSel =
              item.type === "multiple"
                ? userAnswers[currentIndex].includes(i)
                : userAnswers[currentIndex] === i;
            html += `<div class="option ${
              isSel ? "selected" : ""
            }" onclick="handleSelect(${i})">${String.fromCharCode(
              65 + i
            )}. ${opt}</div>`;
          });
          html += `</div>`;
        }
        document.getElementById("q-container").innerHTML = html;
        document.getElementById("next-btn").innerText =
          currentIndex === quizData.length - 1 ? "å®Œæˆæäº¤" : "ä¸‹ä¸€é¢˜";
        window.scrollTo(0, 0);
      }

      function handleSelect(idx) {
        const q = quizData[currentIndex];
        if (q.type === "multiple") {
          const pos = userAnswers[currentIndex].indexOf(idx);
          pos > -1
            ? userAnswers[currentIndex].splice(pos, 1)
            : userAnswers[currentIndex].push(idx);
        } else {
          userAnswers[currentIndex] = idx;
        }
        renderQ();
      }

      function move(dir) {
        if (currentIndex + dir >= 0 && currentIndex + dir < quizData.length) {
          currentIndex += dir;
          renderQ();
        } else if (currentIndex + dir >= quizData.length) {
          confirmEarlySubmit();
        }
      }

      function toggleSheet(show) {
        const overlay = document.getElementById("sheet-overlay");
        if (show) {
          const grid = document.getElementById("sheet-grid");
          grid.innerHTML = quizData
            .map((q, i) => {
              const ans = userAnswers[i];
              const isDone =
                q.type === "multiple"
                  ? ans.length > 0
                  : Array.isArray(ans)
                  ? ans.some((v) => v !== "")
                  : ans !== "";
              return `<div class="sheet-num ${isDone ? "done" : ""} ${
                i === currentIndex ? "current" : ""
              }" onclick="jumpTo(${i})">${i + 1}</div>`;
            })
            .join("");
          overlay.style.display = "block";
        } else {
          overlay.style.display = "none";
        }
      }

      function jumpTo(idx) {
        currentIndex = idx;
        renderQ();
        toggleSheet(false);
      }

      function confirmEarlySubmit() {
        const unanswered = userAnswers.filter((a, idx) => {
          const q = quizData[idx];
          if (q.type === "multiple") return a.length === 0;
          if (Array.isArray(a)) return a.every((v) => v === "");
          return a === "";
        }).length;
        if (
          confirm(
            unanswered > 0
              ? `è¿˜æœ‰ ${unanswered} é¢˜æ²¡åšå®Œï¼Œç¡®å®šè¦äº¤å·å—ï¼Ÿ`
              : `ç¡®å®šäº¤å·å—ï¼Ÿ`
          )
        )
          submitQuiz();
      }

      function submitQuiz() {
        let correct = 0;
        quizData.forEach((q, i) => {
          const u = userAnswers[i];
          if (q.type === "multiple") {
            if (
              JSON.stringify([...u].sort()) ===
              JSON.stringify([...q.ans].sort())
            )
              correct++;
          } else if (q.type === "blank") {
            if (Array.isArray(q.ans)) {
              const isAllRight = q.ans.every(
                (val, idx) =>
                  val.toString().trim() === (u[idx] || "").toString().trim()
              );
              if (isAllRight) correct++;
            } else {
              if (u.toString().trim() === q.ans.toString().trim()) correct++;
            }
          } else {
            if (u === q.ans) correct++;
          }
        });
        document.getElementById("quiz-mode").style.display = "none";
        document.getElementById("result-panel").style.display = "block";
        document.getElementById("accuracy-rate").innerText =
          ((correct / quizData.length) * 100).toFixed(1) + "%";
        document.getElementById(
          "score-summary"
        ).innerText = `ç­”å¯¹ ${correct} é¢˜ / å…± ${quizData.length} é¢˜`;
      }

      function enterReview() {
        document.getElementById("result-panel").style.display = "none";
        document.getElementById("review-area").style.display = "block";
        let html = "";
        quizData.forEach((q, i) => {
          const u = userAnswers[i];

          // åˆ¤å®šé€»è¾‘ä¿®å¤
          let isAllCorrect = false;
          if (q.type === "multiple") {
            isAllCorrect =
              JSON.stringify([...u].sort()) ===
              JSON.stringify([...q.ans].sort());
          } else if (Array.isArray(q.ans)) {
            isAllCorrect = q.ans.every(
              (val, idx) =>
                val.toString().trim() === (u[idx] || "").toString().trim()
            );
          } else {
            isAllCorrect = u.toString().trim() === q.ans.toString().trim();
          }

          html += `<div class="review-card">
                   <p><b><span class="status-dot" style="background:${
                     isAllCorrect ? "var(--success)" : "var(--error)"
                   }"></span>${i + 1}. ${q.q}</b></p>`;

          if (q.img) html += `<img src="${q.img}" class="q-img">`;

          if (q.type !== "blank") {
            q.options.forEach((opt, idx) => {
              // åˆ¤å®šå½“å‰é€‰é¡¹æ˜¯å¦å±äºæ­£ç¡®ç­”æ¡ˆï¼ˆå¤šé€‰å•é€‰é€šç”¨ï¼‰
              const isOptionCorrect = Array.isArray(q.ans)
                ? q.ans.includes(idx)
                : q.ans === idx;
              // åˆ¤å®šå½“å‰é€‰é¡¹æ˜¯å¦è¢«ç”¨æˆ·å‹¾é€‰äº†
              const isOptionSelected = Array.isArray(u)
                ? u.includes(idx)
                : u === idx;

              html += `<div class="review-opt ${
                isOptionCorrect ? "correct" : isOptionSelected ? "wrong" : ""
              }">${String.fromCharCode(65 + idx)}. ${opt} ${
                isOptionCorrect ? "âœ“" : isOptionSelected ? "âœ—" : ""
              }</div>`;
            });
          }

          const ansTxt = Array.isArray(q.ans)
            ? q.ans
                .map((v) =>
                  q.type === "blank" ? v : String.fromCharCode(65 + v)
                )
                .join(" | ")
            : q.type === "blank"
            ? q.ans
            : String.fromCharCode(65 + q.ans);

          const userTxt = Array.isArray(u)
            ? q.type === "blank"
              ? u.map((v) => v || "ç©º").join(" | ")
              : u.length === 0
              ? "æœªé€‰"
              : u.map((v) => String.fromCharCode(65 + v)).join(",")
            : u === ""
            ? "æœªå¡«"
            : q.type === "blank"
            ? u
            : String.fromCharCode(65 + u);

          html += `<div class="review-badge">
                    <div style="color:var(--success); font-weight:600">æ­£ç¡®ç­”æ¡ˆ: ${ansTxt}</div>
                    <div style="color:${
                      isAllCorrect ? "var(--success)" : "var(--error)"
                    }">ä½ çš„ç­”æ¡ˆ: ${userTxt}</div>
                   </div></div>`;
        });
        document.getElementById("review-list").innerHTML = html;
        window.scrollTo(0, 0);
      }

      function handleFileUpload(e) {
        const reader = new FileReader();
        reader.onload = (ev) => startQuiz(JSON.parse(ev.target.result));
        reader.readAsText(e.target.files[0]);
      }
    </script>
  </body>
</html>
